{% load umap_tags i18n %}
<table class="maps">
  {% if not is_ajax %}
    <thead>
      <tr>
        <th>{% blocktrans %}Name{% endblocktrans %}</th>
        <th>{% blocktrans %}Who can see / edit{% endblocktrans %}</th>
        <th>{% blocktrans %}Last save{% endblocktrans %}</th>
        <th>{% blocktrans %}Owner{% endblocktrans %}</th>
        <th>{% blocktrans %}Actions{% endblocktrans %}</th>
      </tr>
    </thead>
  {% endif %}
  <tbody>
    {% for map_inst in maps %}
      {{ map_inst.preview_settings|json_script:map_inst.unique_id }}
      <tr>
        <td>
          <a href="{{ map_inst.get_absolute_url }}">{{ map_inst.name }}</a>
          <button class="map-opener" data-map-id="{{ map_inst.unique_id }}">{% blocktrans %}Preview{% endblocktrans %}</button>
          <dialog>
            <form method="dialog">
              <div id="{{ map_inst.unique_id }}_target" class="map_fragment"></div>
              <p class="close-dialog">
                <button type="submit">Close</button>
              </p>
            </form>
          </dialog>
        </td>
        <td>{{ map_inst.get_share_status_display }} / {{ map_inst.get_edit_status_display }}</td>
        <td>{{ map_inst.modified_at }}</td>
        <td>
          <a href="{{ map_inst.owner.get_url }}">{{ map_inst.owner }}</a>
        </td>
        <td>
          <a href="{{ map_inst.get_absolute_url }}?share">{% translate "Share" %}</a> |
          <a href="{{ map_inst.get_absolute_url }}?edit">{% translate "Edit" %}</a> |
          <a href="{% url 'map_download' map_inst.pk %}">{% translate "Download" %}</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% if maps.has_next %}
  <div class="col wide">
    <a href="?{% paginate_querystring maps.next_page_number %}"
       class="button more_button neutral">{% trans "More" %}</a>
  </div>
{% endif %}

<style type="text/css">
  dialog {
    width: 90vw;
    height: 90vh;
  }
  .close-dialog {
    text-align: center;
  }
  table.maps .map_fragment {
    display: block;
    width: 100%;
    height: 80vh;
  }
  dialog::backdrop {
    background: #fff5;
    backdrop-filter: blur(4px);
  }
</style>

<script type="text/javascript">
  for (const mapOpener of document.querySelectorAll("button.map-opener")) {
    mapOpener.addEventListener('click', (event) => {
      event.target.nextElementSibling.showModal()
      const mapId = event.target.dataset.mapId
      const previewSettings = JSON.parse(document.getElementById(mapId).textContent)
      const map = new L.U.Map(`${mapId}_target`, previewSettings)
    })
  }
</script>
